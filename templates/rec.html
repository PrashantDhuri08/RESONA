<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Audio Recorder</title>
  </head>
  <body>
    <h1>Audio Recorder</h1>

    <button id="startRecord">Start Recording</button>
    <button id="stopRecord" disabled>Stop Recording</button>
    <button id="upload" disabled>Upload</button>
    <br /><br />

    <audio id="audioPlayback" controls></audio>

    <script>
      let mediaRecorder;
      let audioChunks = [];

      document
        .getElementById("startRecord")
        .addEventListener("click", async () => {
          const stream = await navigator.mediaDevices.getUserMedia({
            audio: true,
          });
          mediaRecorder = new MediaRecorder(stream);

          mediaRecorder.ondataavailable = (event) => {
            audioChunks.push(event.data);
          };

          mediaRecorder.onstop = () => {
            const audioBlob = new Blob(audioChunks, { type: "audio/wav" });
            const audioUrl = URL.createObjectURL(audioBlob);
            document.getElementById("audioPlayback").src = audioUrl;

            // Enable the upload button
            document.getElementById("upload").disabled = false;

            // Store the audio blob for uploading
            window.audioBlob = audioBlob;
          };

          mediaRecorder.start();
          document.getElementById("startRecord").disabled = true;
          document.getElementById("stopRecord").disabled = false;
        });

      document.getElementById("stopRecord").addEventListener("click", () => {
        mediaRecorder.stop();
        document.getElementById("startRecord").disabled = false;
        document.getElementById("stopRecord").disabled = true;
      });

      document.getElementById("upload").addEventListener("click", () => {
        const formData = new FormData();
        formData.append("file", window.audioBlob, "recording.wav");

        fetch("/recognize", {
          method: "POST",
          body: formData,
        })
          .then((response) => response.json())
          .then((data) => {
            alert(data.result);
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("An error occurred.");
          });
      });
    </script>
  </body>
</html>
